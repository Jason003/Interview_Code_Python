class Solution(object):
    def numDistinctIslands2(self, grid):
        seen = set()

        def explore(r, c):
            if (0 <= r < len(grid) and 0 <= c < len(grid[0]) and
                    grid[r][c] and (r, c) not in seen):
                seen.add((r, c))
                shape.add(complex(r, c))
                explore(r + 1, c)
                explore(r - 1, c)
                explore(r, c + 1)
                explore(r, c - 1)

        def canonical(shape):
            def translate(shape):
                w = complex(min(z.real for z in shape),
                            min(z.imag for z in shape))
                return sorted(str(z - w) for z in shape)

            ans = None
            for k in range(4):
                ans = max(ans, translate([z * (1j) ** k for z in shape]))
                ans = max(ans, translate([complex(z.imag, z.real) * (1j) ** k
                                          for z in shape]))
            return tuple(ans)

        shapes = set()
        for r in range(len(grid)):
            for c in range(len(grid[0])):
                shape = set()
                explore(r, c)
                if shape:
                    shapes.add(canonical(shape))

        return len(shapes)
